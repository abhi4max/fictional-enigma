<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Athena AI</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
    text-align: center;
    overflow-x: hidden;
}

h1 {
    font-size: 2.5em;
    margin-bottom: 10px;
}

.subtitle {
    font-size: 1em;
    opacity: 0.9;
    margin-bottom: 15px;
}

#clock {
    font-size: 1.8em;
    font-weight: bold;
    margin-bottom: 20px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    letter-spacing: 2px;
}

button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: 2px solid rgba(255,255,255,0.3);
    padding: 15px 35px;
    border-radius: 50px;
    font-size: 18px;
    cursor: pointer;
    margin: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: transform 0.1s;
}

button:active {
    transform: scale(0.95);
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

#btnStop {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    display: none;
}

#btnStop.show {
    display: inline-block;
}

#status {
    margin-top: 15px;
    font-size: 15px;
    min-height: 20px;
}

#response {
    margin-top: 25px;
    font-size: 16px;
    background: rgba(255,255,255,0.15);
    padding: 20px;
    border-radius: 15px;
    max-width: 700px;
    width: 90%;
    display: none;
    word-wrap: break-word;
}

#response.show {
    display: block;
}

#error {
    color: #ffb3b3;
    margin-top: 15px;
    background: rgba(255,0,0,0.2);
    padding: 10px 20px;
    border-radius: 10px;
    display: none;
    max-width: 700px;
    word-wrap: break-word;
}

#error.show {
    display: block;
}

#thinking {
    display: none;
    margin-top: 15px;
    font-size: 16px;
}

#thinking.active {
    display: block;
    animation: pulse 1.5s infinite;
}

.listening {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
</head>
<body>

<h1>Athena AI üß†</h1>
<div class="subtitle">Your Intelligent Voice Assistant</div>
<div id="clock">00:00:00</div>

<div>
    <button id="btnSpeak">üéôÔ∏è Tap to Speak</button>
    <button id="btnStop">üõë Stop</button>
</div>

<div id="status">Ready to answer your questions</div>
<div id="thinking">ü§î Processing...</div>
<div id="response"></div>
<div id="error"></div>

<script>
const API_KEY = 'CewebMo4zLXel4fhLARKsB1K5z53KPZp';
const API_URL = 'https://api.mistral.ai/v1/chat/completions';

const btnSpeak = document.getElementById('btnSpeak');
const btnStop = document.getElementById('btnStop');
const status = document.getElementById('status');
const response = document.getElementById('response');
const thinking = document.getElementById('thinking');
const errorDiv = document.getElementById('error');

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const synth = window.speechSynthesis;

let recognition = null;
let isListening = false;
let conversationHistory = [];

// Real-time clock update
function updateClock() {
    try {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const clockElement = document.getElementById('clock');
        if (clockElement) {
            clockElement.textContent = `${hours}:${minutes}:${seconds}`;
        }
    } catch (e) {
        console.error('Clock error:', e);
    }
}

updateClock();
setInterval(updateClock, 1000);

// Get current date and time information
function getCurrentTimeInfo() {
    try {
        const now = new Date();
        
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const seconds = now.getSeconds();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours % 12 || 12;
        
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        const dayName = days[now.getDay()];
        const monthName = months[now.getMonth()];
        const date = now.getDate();
        const year = now.getFullYear();
        
        return `Current date and time: ${dayName}, ${monthName} ${date}, ${year} at ${displayHours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} ${ampm}.`;
    } catch (e) {
        console.error('Time info error:', e);
        return 'Time information unavailable.';
    }
}

function speak(text) {
    try {
        if (!synth) return;
        synth.cancel();
        btnStop.classList.add('show');
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        utterance.onend = () => {
            btnStop.classList.remove('show');
        };
        
        utterance.onerror = (e) => {
            console.error('Speech error:', e);
            btnStop.classList.remove('show');
        };
        
        synth.speak(utterance);
    } catch (e) {
        console.error('Speak function error:', e);
    }
}

function stopSpeech() {
    try {
        if (synth) synth.cancel();
        btnStop.classList.remove('show');
    } catch (e) {
        console.error('Stop speech error:', e);
    }
}

if (!SpeechRecognition) {
    errorDiv.textContent = 'Speech recognition not supported. Please use Chrome or Edge browser.';
    errorDiv.classList.add('show');
    btnSpeak.disabled = true;
} else {
    try {
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onresult = (event) => {
            try {
                const transcript = event.results[0][0].transcript;
                status.textContent = 'You said: "' + transcript + '"';
                processQuestion(transcript);
            } catch (e) {
                console.error('Recognition result error:', e);
                errorDiv.textContent = 'Error processing speech.';
                errorDiv.classList.add('show');
            }
        };

        recognition.onerror = (event) => {
            stopListening();
            if (event.error === 'no-speech') {
                errorDiv.textContent = 'No speech detected. Please try again.';
                errorDiv.classList.add('show');
            } else if (event.error === 'network') {
                errorDiv.textContent = 'Network error. Check your connection.';
                errorDiv.classList.add('show');
            } else {
                errorDiv.textContent = 'Recognition error: ' + event.error;
                errorDiv.classList.add('show');
            }
        };

        recognition.onend = () => {
            stopListening();
        };
    } catch (e) {
        console.error('Recognition setup error:', e);
        errorDiv.textContent = 'Could not initialize speech recognition.';
        errorDiv.classList.add('show');
        btnSpeak.disabled = true;
    }
}

btnSpeak.addEventListener('click', () => {
    if (isListening) {
        stopListening();
    } else {
        startListening();
    }
});

btnStop.addEventListener('click', () => {
    stopSpeech();
    stopListening();
});

function startListening() {
    errorDiv.classList.remove('show');
    response.classList.remove('show');
    
    try {
        recognition.start();
        isListening = true;
        btnSpeak.textContent = 'üî¥ Listening...';
        btnSpeak.classList.add('listening');
        status.textContent = 'üé§ Listening... Speak now';
    } catch (e) {
        console.error('Start listening error:', e);
        if (e.name === 'InvalidStateError') {
            setTimeout(startListening, 200);
        }
    }
}

function stopListening() {
    try {
        if (recognition) {
            recognition.stop();
        }
    } catch (e) {
        console.error('Stop listening error:', e);
    }
    isListening = false;
    btnSpeak.textContent = 'üéôÔ∏è Tap to Speak';
    btnSpeak.classList.remove('listening');
    status.textContent = 'Ready to answer your questions';
}

async function processQuestion(message) {
    if (!message || message.trim() === '') {
        errorDiv.textContent = 'No message to process.';
        errorDiv.classList.add('show');
        return;
    }

    btnSpeak.disabled = true;
    thinking.classList.add('active');
    errorDiv.classList.remove('show');

    conversationHistory.push({
        role: 'user',
        content: message
    });

    const timeInfo = getCurrentTimeInfo();

    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + API_KEY
            },
            body: JSON.stringify({
                model: 'mistral-small-latest',
                messages: [
                    {
                        role: 'system',
                        content: `You are Athena, a helpful AI voice assistant created by Abhijit Singha from Assam, India. Keep responses under 80 words. ${timeInfo} Use this real-time information to answer questions about current time, date, day, etc.`
                    },
                    ...conversationHistory
                ],
                max_tokens: 250,
                temperature: 0.7
            })
        });

        if (!res.ok) {
            throw new Error('API Error: ' + res.status + ' - ' + res.statusText);
        }

        const data = await res.json();
        
        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error('Invalid API response format');
        }
        
        const aiResponse = data.choices[0].message.content;

        response.innerHTML = '<strong>You:</strong> ' + escapeHtml(message) + '<br><br><strong>Athena:</strong> ' + escapeHtml(aiResponse);
        response.classList.add('show');
        
        speak(aiResponse);

        conversationHistory.push({
            role: 'assistant',
            content: aiResponse
        });

        if (conversationHistory.length > 10) {
            conversationHistory = conversationHistory.slice(-10);
        }

    } catch (err) {
        console.error('Process question error:', err);
        errorDiv.textContent = 'Error: ' + err.message;
        errorDiv.classList.add('show');
        speak('Sorry, I encountered an error. Please try again.');
    } finally {
        thinking.classList.remove('active');
        btnSpeak.disabled = false;
        status.textContent = 'Ready for your next question';
    }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize with greeting
setTimeout(() => {
    try {
        speak('Hello! I am Athena. How can I help you today?');
    } catch (e) {
        console.error('Initial greeting error:', e);
    }
}, 1000);

// Handle page visibility changes
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        stopSpeech();
        stopListening();
    }
});
</script>

</body>
</html>