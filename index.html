<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Athena AI üß†</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    text-align: center;
    padding: 20px;
}

h1 {
    font-size: 2.5em;
    margin-bottom: 10px;
    color: #fff;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.subtitle {
    font-size: 1em;
    opacity: 0.9;
    margin-bottom: 30px;
}

.button-container {
    display: flex;
    gap: 15px;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
}

button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: 2px solid rgba(255,255,255,0.3);
    padding: 15px 35px;
    border-radius: 50px;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    font-weight: 600;
}

button:active {
    transform: scale(0.95);
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

#btnStop {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    display: none;
}

#btnStop.show {
    display: inline-block;
}

#status {
    margin-top: 15px;
    font-size: 15px;
    opacity: 0.9;
    min-height: 20px;
}

#response {
    margin-top: 25px;
    font-size: 16px;
    background-color: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    padding: 20px;
    border-radius: 15px;
    width: 90%;
    max-width: 700px;
    line-height: 1.6;
    text-align: left;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: none;
}

#response.show {
    display: block;
}

#error {
    color: #ffb3b3;
    margin-top: 15px;
    background-color: rgba(255,0,0,0.2);
    padding: 10px 20px;
    border-radius: 10px;
    display: none;
}

#error.show {
    display: block;
}

#thinking {
    display: none;
    margin-top: 15px;
    font-size: 16px;
    animation: pulse 1.5s ease-in-out infinite;
}

#thinking.active {
    display: block;
}

.listening {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
    animation: glow 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes glow {
    0%, 100% { box-shadow: 0 0 20px rgba(245, 87, 108, 0.5); }
    50% { box-shadow: 0 0 30px rgba(245, 87, 108, 0.8); }
}
</style>
</head>
<body>
<h1>Athena AI üß†</h1>
<div class="subtitle">Your Intelligent Voice Assistant</div>

<div class="button-container">
    <button id="btnSpeak">üéôÔ∏è Tap to Speak</button>
    <button id="btnStop">üõë Stop</button>
</div>
<div id="status">Ready to answer your questions</div>
<div id="thinking">ü§î Processing your question...</div>
<div id="response"></div>
<div id="error"></div>

<script>
const API_KEY = 'CewebMo4zLXel4fhLARKsB1K5z53KPZp';
const API_URL = 'https://api.mistral.ai/v1/chat/completions';

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const speechSynthesis = window.speechSynthesis;

const btnSpeak = document.getElementById('btnSpeak');
const btnStop = document.getElementById('btnStop');
const status = document.getElementById('status');
const response = document.getElementById('response');
const thinking = document.getElementById('thinking');
const errorDiv = document.getElementById('error');

let recognition = null;
let isListening = false;
let isSpeaking = false;
let conversationHistory = [];

function speak(text) {
    if (!speechSynthesis) return;
    
    speechSynthesis.cancel();
    
    isSpeaking = true;
    btnStop.classList.add('show');
    
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 0.95;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    
    const voices = speechSynthesis.getVoices();
    const preferredVoice = voices.find(v => 
        v.lang === 'en-US' && (
            v.name.includes('Google') || 
            v.name.includes('Female') ||
            v.name.includes('Samantha')
        )
    );
    if (preferredVoice) {
        utterance.voice = preferredVoice;
    }
    
    utterance.onend = () => {
        isSpeaking = false;
        btnStop.classList.remove('show');
    };
    
    utterance.onerror = () => {
        isSpeaking = false;
        btnStop.classList.remove('show');
    };
    
    speechSynthesis.speak(utterance);
}

function stopSpeaking() {
    if (speechSynthesis) {
        speechSynthesis.cancel();
        isSpeaking = false;
        btnStop.classList.remove('show');
    }
}

if (speechSynthesis) {
    speechSynthesis.getVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
    }
}

if (!SpeechRecognition) {
    showError('Speech recognition not supported. Please use Chrome or Edge.');
    btnSpeak.disabled = true;
} else {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.continuous = false;

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const lowerTranscript = transcript.toLowerCase();
        
        if (lowerTranscript.includes('stop') || lowerTranscript.includes('quiet')) {
            stopSpeaking();
            status.textContent = 'Speech stopped';
            speak("Stopped");
            return;
        }
        
        status.textContent = `You asked: "${transcript}"`;
        processQuestion(transcript);
    };

    recognition.onerror = (event) => {
        stopListening();
        if (event.error === 'no-speech') {
            showError('No speech detected. Please try again.');
        } else if (event.error === 'not-allowed') {
            showError('Microphone permission denied. Please allow microphone access.');
        } else if (event.error === 'aborted') {
            // Ignore aborted errors
        } else {
            showError('Error: ' + event.error);
        }
    };

    recognition.onend = () => {
        stopListening();
    };
}

setTimeout(() => {
    speak("Hello! I am Athena, your intelligent voice assistant. How can I help you today?");
}, 1000);

btnSpeak.addEventListener('click', () => {
    if (!recognition) return;
    
    if (isSpeaking) {
        stopSpeaking();
        status.textContent = 'Speech stopped';
        return;
    }
    
    if (isListening) {
        stopListening();
    } else {
        startListening();
    }
});

btnStop.addEventListener('click', () => {
    stopSpeaking();
    stopListening();
    btnStop.classList.remove('show');
    status.textContent = 'Stopped';
});

function startListening() {
    hideError();
    response.classList.remove('show');
    
    try {
        if (isListening) {
            recognition.stop();
        }
        
        setTimeout(() => {
            recognition.start();
            isListening = true;
            btnSpeak.textContent = 'üî¥ Listening...';
            btnSpeak.classList.add('listening');
            status.textContent = 'üé§ Listening... Speak now';
            thinking.classList.remove('active');
        }, 100);
    } catch (e) {
        showError('Could not start: ' + e.message);
        stopListening();
    }
}

function stopListening() {
    try {
        if (recognition && isListening) {
            recognition.stop();
        }
    } catch (e) {}
    
    isListening = false;
    btnSpeak.textContent = 'üéôÔ∏è Tap to Speak';
    btnSpeak.classList.remove('listening');
    
    if (!thinking.classList.contains('active')) {
        status.textContent = 'Ready to answer your questions';
    }
}

function showError(msg) {
    errorDiv.textContent = msg;
    errorDiv.classList.add('show');
    setTimeout(() => {
        errorDiv.classList.remove('show');
    }, 5000);
}

function hideError() {
    errorDiv.textContent = '';
    errorDiv.classList.remove('show');
}

async function processQuestion(message) {
    btnSpeak.disabled = true;
    thinking.classList.add('active');
    hideError();

    conversationHistory.push({
        role: 'user',
        content: message
    });

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        const res = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: 'mistral-small-latest',
                messages: [
                    {
                        role: 'system',
                        content: `You are Athena, a helpful AI voice assistant created by Abhijit Singha from Assam, India. Only mention your creator when specifically asked "who made you" or "who created you". For all other questions, answer naturally. Current date: ${new Date().toLocaleDateString('en-IN', { dateStyle: 'full' })}. Keep responses concise and under 80 words.`
                    },
                    ...conversationHistory
                ],
                max_tokens: 250,
                temperature: 0.7
            }),
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            throw new Error(errorData.message || `API Error ${res.status}`);
        }

        const data = await res.json();
        const aiResponse = data.choices[0].message.content;

        response.innerHTML = `<strong>You:</strong> ${escapeHtml(message)}<br><br><strong>Athena:</strong> ${escapeHtml(aiResponse)}`;
        response.classList.add('show');
        
        speak(aiResponse);

        conversationHistory.push({
            role: 'assistant',
            content: aiResponse
        });

        if (conversationHistory.length > 10) {
            conversationHistory = conversationHistory.slice(-10);
        }

    } catch (err) {
        console.error('Error:', err);
        
        let errorMsg = 'Sorry, I encountered an error.';
        
        if (err.name === 'AbortError') {
            errorMsg = 'Request timeout. Please try again.';
        } else if (err.message.includes('401')) {
            errorMsg = 'API authentication failed. Please check the API key.';
        } else if (err.message.includes('Failed to fetch')) {
            errorMsg = 'Network error. Please check your internet connection.';
        }
        
        showError(errorMsg);
        response.innerHTML = `<strong>You:</strong> ${escapeHtml(message)}<br><br><strong>Athena:</strong> ${errorMsg}`;
        response.classList.add('show');
        speak(errorMsg);
        
    } finally {
        thinking.classList.remove('active');
        btnSpeak.disabled = false;
        status.textContent = 'Ready for your next question';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
</body>
</html>    margin-bottom: 30px;
}

.button-container {
    display: flex;
    gap: 15px;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
}

button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: 2px solid rgba(255,255,255,0.3);
    padding: 15px 35px;
    border-radius: 50px;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    font-weight: 600;
}

button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

#btnStop {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    display: none;
}

#btnStop.show {
    display: inline-block;
}

#status {
    margin-top: 15px;
    font-size: 15px;
    opacity: 0.9;
    min-height: 20px;
}

#response {
    margin-top: 25px;
    font-size: 16px;
    background-color: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    padding: 20px;
    border-radius: 15px;
    width: 90%;
    max-width: 700px;
    line-height: 1.6;
    text-align: left;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: none;
}

#response.show {
    display: block;
}

#error {
    color: #ffb3b3;
    margin-top: 15px;
    background-color: rgba(255,0,0,0.2);
    padding: 10px 20px;
    border-radius: 10px;
    display: none;
}

#error.show {
    display: block;
}

#thinking {
    display: none;
    margin-top: 15px;
    font-size: 16px;
    animation: pulse 1.5s ease-in-out infinite;
}

#thinking.active {
    display: block;
}

.listening {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
    animation: glow 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes glow {
    0%, 100% { box-shadow: 0 0 20px rgba(245, 87, 108, 0.5); }
    50% { box-shadow: 0 0 30px rgba(245, 87, 108, 0.8); }
}
</style>
</head>
<body>
<h1>Athena AI üß†</h1>
<div class="subtitle">Your Intelligent Voice Assistant</div>

<div class="button-container">
    <button id="btnSpeak">üéôÔ∏è Tap to Speak</button>
    <button id="btnStop">üõë Stop</button>
</div>
<div id="status">Ready to answer your questions</div>
<div id="thinking">ü§î Processing your question...</div>
<div id="response"></div>
<div id="error"></div>

<script>
const API_KEY = 'CewebMo4zLXel4fhLARKsB1K5z53KPZp';
const API_URL = 'https://api.mistral.ai/v1/chat/completions';

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
const SpeechSynthesis = window.speechSynthesis || null;

const btnSpeak = document.getElementById('btnSpeak');
const btnStop = document.getElementById('btnStop');
const status = document.getElementById('status');
const response = document.getElementById('response');
const thinking = document.getElementById('thinking');
const errorDiv = document.getElementById('error');

let recognition = null;
let isListening = false;
let isSpeaking = false;
let currentUtterance = null;
let streamingText = '';
let speechQueue = [];
let isSpeechQueueProcessing = false;
let conversationHistory = [];

function speakChunked(text, isFinal = false) {
    if (!SpeechSynthesis) return;
    
    speechQueue.push({ text, isFinal });
    processSpeechQueue();
}

function processSpeechQueue() {
    if (isSpeechQueueProcessing || speechQueue.length === 0) return;
    
    isSpeechQueueProcessing = true;
    const { text, isFinal } = speechQueue.shift();
    
    if (!text.trim()) {
        isSpeechQueueProcessing = false;
        processSpeechQueue();
        return;
    }
    
    isSpeaking = true;
    btnStop.classList.add('show');
    
    const utter = new SpeechSynthesisUtterance(String(text));
    utter.lang = 'en-US';
    utter.rate = 0.95;
    utter.pitch = 1.1;
    utter.volume = 1;
    
    const voices = SpeechSynthesis.getVoices();
    const femaleVoice = voices.find(v => 
        v.name.includes('Female') || 
        v.name.includes('Samantha') || 
        v.name.includes('Karen') ||
        v.name.includes('Victoria')
    );
    if (femaleVoice) utter.voice = femaleVoice;
    
    utter.onend = () => {
        isSpeechQueueProcessing = false;
        if (speechQueue.length > 0) {
            processSpeechQueue();
        } else if (isFinal) {
            isSpeaking = false;
            btnStop.classList.remove('show');
        }
    };
    
    utter.onerror = () => {
        isSpeechQueueProcessing = false;
        isSpeaking = false;
        btnStop.classList.remove('show');
    };
    
    currentUtterance = utter;
    SpeechSynthesis.speak(utter);
}

function stopSpeaking() {
    if (SpeechSynthesis) {
        SpeechSynthesis.cancel();
        speechQueue = [];
        isSpeaking = false;
        isSpeechQueueProcessing = false;
        currentUtterance = null;
        btnStop.classList.remove('show');
    }
}

if (SpeechSynthesis) {
    SpeechSynthesis.getVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => SpeechSynthesis.getVoices();
    }
}

if (!SpeechRecognition) {
    showError('Speech recognition not supported. Please use Chrome, Edge, or Safari.');
    btnSpeak.disabled = true;
} else {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const lowerTranscript = transcript.toLowerCase();
        
        if (lowerTranscript.includes('stop') || lowerTranscript.includes('shut up') || lowerTranscript.includes('quiet')) {
            stopSpeaking();
            status.textContent = 'Speech stopped';
            speakChunked("Stopped", true);
            return;
        }
        
        status.textContent = `You asked: "${transcript}"`;
        processQuestion(transcript);
    };

    recognition.onerror = (event) => {
        stopListening();
        if (event.error === 'no-speech') {
            showError('No speech detected. Please try again.');
        } else if (event.error === 'not-allowed') {
            showError('Microphone access denied. Please allow microphone permissions.');
        } else {
            showError('Speech error: ' + event.error);
        }
    };

    recognition.onend = () => stopListening();
}

window.addEventListener('load', () => {
    setTimeout(() => {
        speakChunked("Hello! I am Athena, your intelligent voice assistant. How can I help you today?", true);
    }, 500);
});

btnSpeak.addEventListener('click', () => {
    if (!recognition) return;
    
    if (isSpeaking) {
        stopSpeaking();
        status.textContent = 'Speech stopped';
        return;
    }
    
    if (isListening) {
        stopListening();
    } else {
        startListening();
    }
});

btnStop.addEventListener('click', () => {
    stopSpeaking();
    stopListening();
    btnStop.classList.remove('show');
    status.textContent = 'Stopped';
});

function startListening() {
    hideError();
    response.classList.remove('show');
    try {
        recognition.start();
        isListening = true;
        btnSpeak.textContent = 'üî¥ Listening...';
        btnSpeak.classList.add('listening');
        status.textContent = 'üé§ Listening... Speak now';
        thinking.classList.remove('active');
    } catch (e) {
        showError('Could not start listening: ' + e.message);
    }
}

function stopListening() {
    try {
        if (recognition && isListening) recognition.stop();
    } catch (e) {}
    isListening = false;
    btnSpeak.textContent = 'üéôÔ∏è Tap to Speak';
    btnSpeak.classList.remove('listening');
    if (!thinking.classList.contains('active')) {
        status.textContent = 'Ready to answer your questions';
    }
}

function showError(msg) {
    errorDiv.textContent = msg;
    errorDiv.classList.add('show');
}

function hideError() {
    errorDiv.textContent = '';
    errorDiv.classList.remove('show');
}

async function processQuestion(message) {
    btnSpeak.disabled = true;
    thinking.classList.add('active');
    hideError();
    streamingText = '';

    conversationHistory.push({
        role: 'user',
        content: message
    });

    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: 'mistral-small-latest',
                messages: [
                    {
                        role: 'system',
                        content: `You are Athena, a helpful AI voice assistant created by Abhijit Singha from India, Assam, Guwahati, Silchar, Chandpur. Only mention your creator when specifically asked "who made you" or "who created you". For all other questions, answer naturally without mentioning your creator. Current date and time: ${new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', dateStyle: 'full', timeStyle: 'short' })}. Keep responses concise and conversational, ideally under 100 words.`
                    },
                    ...conversationHistory
                ],
                stream: false,
                max_tokens: 300,
                temperature: 0.7
            })
        });

        if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            throw new Error(`API Error: ${res.status} - ${errorData.message || res.statusText}`);
        }

        const data = await res.json();
        const aiResponse = data.choices[0].message.content;

        streamingText = aiResponse;
        response.innerHTML = `<strong>You:</strong> ${message}<br><br><strong>Athena:</strong> ${streamingText}`;
        response.classList.add('show');
        
        speakChunked(aiResponse, true);

        conversationHistory.push({
            role: 'assistant',
            content: aiResponse
        });

        if (conversationHistory.length > 10) {
            conversationHistory.splice(0, conversationHistory.length - 10);
        }

    } catch (err) {
        console.error('API Error:', err);
        showError('Error: ' + err.message);
        const fallback = "I'm sorry, I encountered an error. Please try again.";
        response.innerHTML = `<strong>You:</strong> ${message}<br><br><strong>Athena:</strong> ${fallback}`;
        response.classList.add('show');
        speakChunked(fallback, true);
    } finally {
        thinking.classList.remove('active');
        btnSpeak.disabled = false;
        status.textContent = 'Ready for your next question';
    }
}
</script>
</body>
</html>    flex-wrap:wrap;  
}  
button{  
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  
    color:white;  
    border:2px solid rgba(255,255,255,0.3);  
    padding:15px 35px;  
    border-radius:50px;  
    font-size:18px;  
    cursor:pointer;  
    transition:all 0.3s ease;  
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);  
    font-weight:600;  
}  
button:hover:not(:disabled){  
    transform: translateY(-2px);  
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);  
}  
button:disabled{  
    opacity:0.6;  
    cursor:not-allowed;  
}  
#btnStop{  
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);  
    display:none;  
}  
#btnStop.show{  
    display:inline-block;  
}  
#status{  
    margin-top:15px;  
    font-size:15px;  
    opacity:0.9;  
    min-height:20px;  
}  
#response{  
    margin-top:25px;  
    font-size:16px;  
    background-color:rgba(255,255,255,0.15);  
    backdrop-filter: blur(10px);  
    padding:20px;  
    border-radius:15px;  
    width:90%;  
    max-width:700px;  
    line-height:1.6;  
    text-align:left;  
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);  
    display:none;  
}  
#response.show{  
    display:block;  
}  
#error{  
    color:#ffb3b3;  
    margin-top:15px;  
    background-color:rgba(255,0,0,0.2);  
    padding:10px 20px;  
    border-radius:10px;  
    display:none;  
}  
#error.show{  
    display:block;  
}  
#thinking{  
    display:none;  
    margin-top:15px;  
    font-size:16px;  
    animation: pulse 1.5s ease-in-out infinite;  
}  
#thinking.active{  
    display:block;  
}  
.listening{  
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;  
    animation: glow 1.5s ease-in-out infinite;  
}  
@keyframes pulse {  
    0%, 100% { opacity: 1; }  
    50% { opacity: 0.5; }  
}  
@keyframes glow {  
    0%, 100% { box-shadow: 0 0 20px rgba(245, 87, 108, 0.5); }  
    50% { box-shadow: 0 0 30px rgba(245, 87, 108, 0.8); }  
}  
</style>  
</head>  
<body>  
<h1>Athena AI üß†</h1>  
<div class="subtitle">Your Intelligent Voice Assistant</div>  

<div class="button-container">  
    <button id="btnSpeak">üéôÔ∏è Tap to Speak</button>  
    <button id="btnStop">üõë Stop</button>  
</div>  
<div id="status">Ready to answer your questions</div>  
<div id="thinking">ü§î Processing your question...</div>  
<div id="response"></div>  
<div id="error"></div>  

<script>  
const API_KEY = 'CewebMo4zLXel4fhLARKsB1K5z53KPZp';
const API_URL = 'https://api.mistral.ai/v1/chat/completions';

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;  
const SpeechSynthesis = window.speechSynthesis || null;  
  
const btnSpeak = document.getElementById('btnSpeak');  
const btnStop = document.getElementById('btnStop');  
const status = document.getElementById('status');  
const response = document.getElementById('response');  
const thinking = document.getElementById('thinking');  
const errorDiv = document.getElementById('error');  
  
let recognition = null;  
let isListening = false;  
let isSpeaking = false;  
let currentUtterance = null;
let streamingText = '';
let speechQueue = [];
let isSpeechQueueProcessing = false;
let conversationHistory = [];

function speakChunked(text, isFinal = false) {
    if (!SpeechSynthesis) return;
    
    speechQueue.push({ text, isFinal });
    processSpeechQueue();
}

function processSpeechQueue() {
    if (isSpeechQueueProcessing || speechQueue.length === 0) return;
    
    isSpeechQueueProcessing = true;
    const { text, isFinal } = speechQueue.shift();
    
    if (!text.trim()) {
        isSpeechQueueProcessing = false;
        processSpeechQueue();
        return;
    }
    
    isSpeaking = true;
    btnStop.classList.add('show');
    
    const utter = new SpeechSynthesisUtterance(String(text));
    utter.lang = 'en-US';
    utter.rate = 0.95;
    utter.pitch = 1.1;
    utter.volume = 1;
    
    const voices = SpeechSynthesis.getVoices();
    const femaleVoice = voices.find(v => 
        v.name.includes('Female') || 
        v.name.includes('Samantha') || 
        v.name.includes('Karen') ||
        v.name.includes('Victoria')
    );
    if (femaleVoice) utter.voice = femaleVoice;
    
    utter.onend = () => {
        isSpeechQueueProcessing = false;
        if (speechQueue.length > 0) {
            processSpeechQueue();
        } else if (isFinal) {
            isSpeaking = false;
            btnStop.classList.remove('show');
        }
    };
    
    utter.onerror = () => {
        isSpeechQueueProcessing = false;
        isSpeaking = false;
        btnStop.classList.remove('show');
    };
    
    currentUtterance = utter;
    SpeechSynthesis.speak(utter);
}

function stopSpeaking() {
    if (SpeechSynthesis) {
        SpeechSynthesis.cancel();
        speechQueue = [];
        isSpeaking = false;
        isSpeechQueueProcessing = false;
        currentUtterance = null;
        btnStop.classList.remove('show');
    }
}

if (SpeechSynthesis) {
    SpeechSynthesis.getVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => SpeechSynthesis.getVoices();
    }
}

if (!SpeechRecognition) {
    showError('Speech recognition not supported. Please use Chrome, Edge, or Safari.');
    btnSpeak.disabled = true;
} else {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const lowerTranscript = transcript.toLowerCase();
        
        if (lowerTranscript.includes('stop') || lowerTranscript.includes('shut up') || lowerTranscript.includes('quiet')) {
            stopSpeaking();
            status.textContent = 'Speech stopped';
            speakChunked("Stopped", true);
            return;
        }
        
        status.textContent = `You asked: "${transcript}"`;
        processQuestion(transcript);
    };

    recognition.onerror = (event) => {
        stopListening();
        if (event.error === 'no-speech') {
            showError('No speech detected. Please try again.');
        } else if (event.error === 'not-allowed') {
            showError('Microphone access denied. Please allow microphone permissions.');
        } else {
            showError('Speech error: ' + event.error);
        }
    };

    recognition.onend = () => stopListening();
}

window.addEventListener('load', () => {
    setTimeout(() => {
        speakChunked("Hello! I am Athena, your intelligent voice assistant. How can I help you today?", true);
    }, 500);
});

btnSpeak.addEventListener('click', () => {
    if (!recognition) return;
    
    if (isSpeaking) {
        stopSpeaking();
        status.textContent = 'Speech stopped';
        return;
    }
    
    if (isListening) {
        stopListening();
    } else {
        startListening();
    }
});

btnStop.addEventListener('click', () => {
    stopSpeaking();
    stopListening();
    btnStop.classList.remove('show');
    status.textContent = 'Stopped';
});

function startListening() {
    hideError();
    response.classList.remove('show');
    try {
        recognition.start();
        isListening = true;
        btnSpeak.textContent = 'üî¥ Listening...';
        btnSpeak.classList.add('listening');
        status.textContent = 'üé§ Listening... Speak now';
        thinking.classList.remove('active');
    } catch (e) {
        showError('Could not start listening: ' + e.message);
    }
}

function stopListening() {
    try {
        if (recognition && isListening) recognition.stop();
    } catch (e) {}
    isListening = false;
    btnSpeak.textContent = 'üéôÔ∏è Tap to Speak';
    btnSpeak.classList.remove('listening');
    if (!thinking.classList.contains('active')) {
        status.textContent = 'Ready to answer your questions';
    }
}

function showError(msg) {
    errorDiv.textContent = msg;
    errorDiv.classList.add('show');
}

function hideError() {
    errorDiv.textContent = '';
    errorDiv.classList.remove('show');
}

async function processQuestion(message) {
    btnSpeak.disabled = true;
    thinking.classList.add('active');
    hideError();
    streamingText = '';

    conversationHistory.push({
        role: 'user',
        content: message
    });

    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: 'mistral-small-latest',
                messages: [
                    {
                        role: 'system',
                        content: `You are Athena, a helpful AI voice assistant created by Abhijit Singha from India, Assam, Guwahati, Silchar, Chandpur. Only mention your creator when specifically asked "who made you" or "who created you". For all other questions, answer naturally without mentioning your creator. Current date and time: ${new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', dateStyle: 'full', timeStyle: 'short' })}. Keep responses concise and conversational, ideally under 100 words.`
                    },
                    ...conversationHistory
                ],
                stream: false,
                max_tokens: 300,
                temperature: 0.7
            })
        });

        if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            throw new Error(`API Error: ${res.status} - ${errorData.message || res.statusText}`);
        }

        const data = await res.json();
        const aiResponse = data.choices[0].message.content;

        streamingText = aiResponse;
        response.innerHTML = `<strong>You:</strong> ${message}<br><br><strong>Athena:</strong> ${streamingText}`;
        response.classList.add('show');
        
        speakChunked(aiResponse, true);

        conversationHistory.push({
            role: 'assistant',
            content: aiResponse
        });

        if (conversationHistory.length > 10) {
            conversationHistory.splice(0, conversationHistory.length - 10);
        }

    } catch (err) {
        console.error('API Error:', err);
        showError('Error: ' + err.message);
        const fallback = "I'm sorry, I encountered an error. Please try again.";
        response.innerHTML = `<strong>You:</strong> ${message}<br><br><strong>Athena:</strong> ${fallback}`;
        response.classList.add('show');
        speakChunked(fallback, true);
    } finally {
        thinking.classList.remove('active');
        btnSpeak.disabled = false;
        status.textContent = 'Ready for your next question';
    }
}
</script>  
</body>  
</html>    flex-wrap:wrap;  
}  
button{  
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  
    color:white;  
    border:2px solid rgba(255,255,255,0.3);  
    padding:15px 35px;  
    border-radius:50px;  
    font-size:18px;  
    cursor:pointer;  
    transition:all 0.3s ease;  
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);  
    font-weight:600;  
}  
button:hover:not(:disabled){  
    transform: translateY(-2px);  
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);  
}  
button:disabled{  
    opacity:0.6;  
    cursor:not-allowed;  
}  
#btnStop{  
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);  
    display:none;  
}  
#btnStop.show{  
    display:inline-block;  
}  
#status{  
    margin-top:15px;  
    font-size:15px;  
    opacity:0.9;  
    min-height:20px;  
}  
#response{  
    margin-top:25px;  
    font-size:16px;  
    background-color:rgba(255,255,255,0.15);  
    backdrop-filter: blur(10px);  
    padding:20px;  
    border-radius:15px;  
    width:90%;  
    max-width:700px;  
    line-height:1.6;  
    text-align:left;  
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);  
    display:none;  
}  
#response.show{  
    display:block;  
}  
#error{  
    color:#ffb3b3;  
    margin-top:15px;  
    background-color:rgba(255,0,0,0.2);  
    padding:10px 20px;  
    border-radius:10px;  
    display:none;  
}  
#error.show{  
    display:block;  
}  
#thinking{  
    display:none;  
    margin-top:15px;  
    font-size:16px;  
    animation: pulse 1.5s ease-in-out infinite;  
}  
#thinking.active{  
    display:block;  
}  
.listening{  
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;  
    animation: glow 1.5s ease-in-out infinite;  
}  
@keyframes pulse {  
    0%, 100% { opacity: 1; }  
    50% { opacity: 0.5; }  
}  
@keyframes glow {  
    0%, 100% { box-shadow: 0 0 20px rgba(245, 87, 108, 0.5); }  
    50% { box-shadow: 0 0 30px rgba(245, 87, 108, 0.8); }  
}  
</style>  
</head>  
<body>  
<h1>Athena AI üß†</h1>  
<div class="subtitle">Your Intelligent Voice Assistant</div>  

<div class="button-container">  
    <button id="btnSpeak">üéôÔ∏è Tap to Speak</button>  
    <button id="btnStop">üõë Stop</button>  
</div>  
<div id="status">Ready to answer your questions</div>  
<div id="thinking">ü§î Processing your question...</div>  
<div id="response"></div>  
<div id="error"></div>  

<script>  
const API_KEY = 'CewebMo4zLXel4fhLARKsB1K5z53KPZp';
const API_URL = 'https://api.mistral.ai/v1/chat/completions';

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;  
const SpeechSynthesis = window.speechSynthesis || null;  
  
const btnSpeak = document.getElementById('btnSpeak');  
const btnStop = document.getElementById('btnStop');  
const status = document.getElementById('status');  
const response = document.getElementById('response');  
const thinking = document.getElementById('thinking');  
const errorDiv = document.getElementById('error');  
  
let recognition = null;  
let isListening = false;  
let isSpeaking = false;  
let currentUtterance = null;
let streamingText = '';
let speechQueue = [];
let isSpeechQueueProcessing = false;
let conversationHistory = [];

function speakChunked(text, isFinal = false) {
    if (!SpeechSynthesis) return;
    
    speechQueue.push({ text, isFinal });
    processSpeechQueue();
}

function processSpeechQueue() {
    if (isSpeechQueueProcessing || speechQueue.length === 0) return;
    
    isSpeechQueueProcessing = true;
    const { text, isFinal } = speechQueue.shift();
    
    if (!text.trim()) {
        isSpeechQueueProcessing = false;
        processSpeechQueue();
        return;
    }
    
    isSpeaking = true;
    btnStop.classList.add('show');
    
    const utter = new SpeechSynthesisUtterance(String(text));
    utter.lang = 'en-US';
    utter.rate = 0.95;
    utter.pitch = 1.1;
    utter.volume = 1;
    
    const voices = SpeechSynthesis.getVoices();
    const femaleVoice = voices.find(v => 
        v.name.includes('Female') || 
        v.name.includes('Samantha') || 
        v.name.includes('Karen') ||
        v.name.includes('Victoria')
    );
    if (femaleVoice) utter.voice = femaleVoice;
    
    utter.onend = () => {
        isSpeechQueueProcessing = false;
        if (speechQueue.length > 0) {
            processSpeechQueue();
        } else if (isFinal) {
            isSpeaking = false;
            btnStop.classList.remove('show');
        }
    };
    
    utter.onerror = () => {
        isSpeechQueueProcessing = false;
        isSpeaking = false;
        btnStop.classList.remove('show');
    };
    
    currentUtterance = utter;
    SpeechSynthesis.speak(utter);
}

function stopSpeaking() {
    if (SpeechSynthesis) {
        SpeechSynthesis.cancel();
        speechQueue = [];
        isSpeaking = false;
        isSpeechQueueProcessing = false;
        currentUtterance = null;
        btnStop.classList.remove('show');
    }
}

if (SpeechSynthesis) {
    SpeechSynthesis.getVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => SpeechSynthesis.getVoices();
    }
}

if (!SpeechRecognition) {
    showError('Speech recognition not supported. Please use Chrome, Edge, or Safari.');
    btnSpeak.disabled = true;
} else {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const lowerTranscript = transcript.toLowerCase();
        
        if (lowerTranscript.includes('stop') || lowerTranscript.includes('shut up') || lowerTranscript.includes('quiet')) {
            stopSpeaking();
            status.textContent = 'Speech stopped';
            speakChunked("Stopped", true);
            return;
        }
        
        status.textContent = `You asked: "${transcript}"`;
        processQuestion(transcript);
    };

    recognition.onerror = (event) => {
        stopListening();
        if (event.error === 'no-speech') {
            showError('No speech detected. Please try again.');
        } else if (event.error === 'not-allowed') {
            showError('Microphone access denied. Please allow microphone permissions.');
        } else {
            showError('Speech error: ' + event.error);
        }
    };

    recognition.onend = () => stopListening();
}

window.addEventListener('load', () => {
    setTimeout(() => {
        speakChunked("Hello! I am Athena, your intelligent voice assistant. How can I help you today?", true);
    }, 500);
});

btnSpeak.addEventListener('click', () => {
    if (!recognition) return;
    
    if (isSpeaking) {
        stopSpeaking();
        status.textContent = 'Speech stopped';
        return;
    }
    
    if (isListening) {
        stopListening();
    } else {
        startListening();
    }
});

btnStop.addEventListener('click', () => {
    stopSpeaking();
    stopListening();
    btnStop.classList.remove('show');
    status.textContent = 'Stopped';
});

function startListening() {
    hideError();
    response.classList.remove('show');
    try {
        recognition.start();
        isListening = true;
        btnSpeak.textContent = 'üî¥ Listening...';
        btnSpeak.classList.add('listening');
        status.textContent = 'üé§ Listening... Speak now';
        thinking.classList.remove('active');
    } catch (e) {
        showError('Could not start listening: ' + e.message);
    }
}

function stopListening() {
    try {
        if (recognition && isListening) recognition.stop();
    } catch (e) {}
    isListening = false;
    btnSpeak.textContent = 'üéôÔ∏è Tap to Speak';
    btnSpeak.classList.remove('listening');
    if (!thinking.classList.contains('active')) {
        status.textContent = 'Ready to answer your questions';
    }
}

function showError(msg) {
    errorDiv.textContent = msg;
    errorDiv.classList.add('show');
}

function hideError() {
    errorDiv.textContent = '';
    errorDiv.classList.remove('show');
}

async function processQuestion(message) {
    btnSpeak.disabled = true;
    thinking.classList.add('active');
    hideError();
    streamingText = '';

    conversationHistory.push({
        role: 'user',
        content: message
    });

    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: 'mistral-small-latest',
                messages: [
                    {
                        role: 'system',
                        content: `You are Athena, a helpful AI voice assistant created by Abhijit Singha from India, Assam, Guwahati, Silchar, Chandpur. Only mention your creator when specifically asked "who made you" or "who created you". For all other questions, answer naturally without mentioning your creator. Current date and time: ${new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', dateStyle: 'full', timeStyle: 'short' })}. Keep responses concise and conversational, ideally under 100 words.`
                    },
                    ...conversationHistory
                ],
                stream: false,
                max_tokens: 300,
                temperature: 0.7
            })
        });

        if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            throw new Error(`API Error: ${res.status} - ${errorData.message || res.statusText}`);
        }

        const data = await res.json();
        const aiResponse = data.choices[0].message.content;

        streamingText = aiResponse;
        response.innerHTML = `<strong>You:</strong> ${message}<br><br><strong>Athena:</strong> ${streamingText}`;
        response.classList.add('show');
        
        speakChunked(aiResponse, true);

        conversationHistory.push({
            role: 'assistant',
            content: aiResponse
        });

        if (conversationHistory.length > 10) {
            conversationHistory.splice(0, conversationHistory.length - 10);
        }

    } catch (err) {
        console.error('API Error:', err);
        showError('Error: ' + err.message);
        const fallback = "I'm sorry, I encountered an error. Please try again.";
        response.innerHTML = `<strong>You:</strong> ${message}<br><br><strong>Athena:</strong> ${fallback}`;
        response.classList.add('show');
        speakChunked(fallback, true);
    } finally {
        thinking.classList.remove('active');
        btnSpeak.disabled = false;
        status.textContent = 'Ready for your next question';
    }
}
</script>  
</body>  
</html>
